<%- await include('../_header'); -%>

<nav class="breadcrumb">
  <ul>
    <li><a href="<%= urlPrefix %>/dashboard">Home</a></li>
    <li>
      <a href="<%= urlPrefix %>/<%= configFunctions.getConfigProperty('shifts.router') %>">
        <span class="icon is-small"><i class="fa-solid <%= configFunctions.getConfigProperty('shifts.iconClass') %>"></i></span>
        <span><%= configFunctions.getConfigProperty('shifts.sectionName') %></span>
      </a>
    </li>
    <li class="is-active">
      <a href="#" aria-current="page">
        <span><%= configFunctions.getConfigProperty('shifts.sectionNameSingular') %> Builder</span>
      </a>
    </li>
  </ul>
</nav>

<h1 class="title is-1">
  <%= configFunctions.getConfigProperty('shifts.sectionNameSingular') %> Builder
</h1>

<div class="message is-info">
  <div class="message-body">
    Use the <%= configFunctions.getConfigProperty('shifts.sectionNameSingular') %> Builder to quickly organize shifts for a date, 
    manage staff and equipment assignments, and organize work orders across multiple shifts.
    <% if (user.userProperties.shifts.canManage) { %>
    You can drag and drop employees, equipment, crews, and work orders between shifts.
    <% } else { %>
    You are viewing in read-only mode.
    <% } %>
  </div>
</div>

<div class="box">
  <div class="columns">
    <div class="column is-one-third">
      <div class="field">
        <label class="label" for="builder--shiftDate">Date</label>
        <div class="control has-icons-left">
          <input
            class="input"
            id="builder--shiftDate"
            name="shiftDate"
            type="text"
            value="<%= new Date().toISOString().split('T')[0] %>"
            placeholder="YYYY-MM-DD"
            required
          />
          <span class="icon is-small is-left">
            <i class="fa-solid fa-calendar"></i>
          </span>
        </div>
        <p class="help">Select a date to view and manage shifts</p>
      </div>
    </div>
    <div class="column is-one-third">
      <div class="field">
        <label class="label" for="builder--viewMode">View</label>
        <div class="control has-icons-left">
          <div class="select is-fullwidth">
            <select id="builder--viewMode" name="viewMode">
              <option value="employees">Employees and Equipment</option>
              <option value="tasks">Tasks</option>
            </select>
          </div>
          <span class="icon is-small is-left">
            <i class="fa-solid fa-eye"></i>
          </span>
        </div>
        <p class="help">Choose what to display in each shift card</p>
      </div>
    </div>
    <% if (user.userProperties.shifts.canUpdate) { %>
    <div class="column is-one-third">
      <div class="field">
        <label class="label">&nbsp;</label>
        <div class="control">
          <button class="button is-success is-fullwidth" id="button--createShift" type="button">
            <span class="icon is-small">
              <i class="fa-solid fa-plus"></i>
            </span>
            <span>Create <%= configFunctions.getConfigProperty('shifts.sectionNameSingular') %></span>
          </button>
        </div>
        <p class="help">Create a new shift for the selected date</p>
      </div>
    </div>
    <% } %>
  </div>
</div>

<div class="columns">
  <div class="column" id="container--shiftBuilderResults">
    <div class="has-text-centered py-6">
      <span class="icon is-large has-text-grey-light">
        <i class="fa-solid fa-3x fa-calendar-days"></i>
      </span>
      <p class="has-text-grey">Select a date to view shifts</p>
    </div>
  </div>
  <% if (user.userProperties.shifts.canUpdate) { %>
  <div class="column is-one-quarter" id="container--availableResources">
    <div class="box">
      <h3 class="title is-5">Available Resources</h3>
      <p class="help mb-3">Drag resources to shifts or drag from shifts here to remove</p>
      
      <!-- Search Filter -->
      <div class="field mb-4">
        <div class="control has-icons-left">
          <input
            class="input is-small"
            id="availableResources--filter"
            type="text"
            placeholder="Search resources..."
          />
          <span class="icon is-small is-left">
            <i class="fa-solid fa-magnifying-glass"></i>
          </span>
        </div>
      </div>

      <div class="mb-4" id="available--crews">
        <h4 class="subtitle is-6 is-clickable resource-section-header" data-section="crews">
          <span class="icon is-small">
            <i class="fa-solid fa-chevron-down"></i>
          </span>
          <span>Crews</span>
          <span class="tag is-info is-light ml-2" id="crews-count">0</span>
        </h4>
        <div class="available-resources-list resource-section-content" data-resource-type="crew">
          <p class="has-text-grey-light is-size-7">No available crews</p>
        </div>
      </div>
      
      <div class="mb-4" id="available--employees">
        <h4 class="subtitle is-6 is-clickable resource-section-header" data-section="employees">
          <span class="icon is-small">
            <i class="fa-solid fa-chevron-down"></i>
          </span>
          <span>Employees</span>
          <span class="tag is-info is-light ml-2" id="employees-count">0</span>
        </h4>
        <div class="available-resources-list resource-section-content" data-resource-type="employee">
          <p class="has-text-grey-light is-size-7">No available employees</p>
        </div>
      </div>
      
      <div id="available--equipment">
        <h4 class="subtitle is-6 is-clickable resource-section-header" data-section="equipment">
          <span class="icon is-small">
            <i class="fa-solid fa-chevron-down"></i>
          </span>
          <span>Equipment</span>
          <span class="tag is-info is-light ml-2" id="equipment-count">0</span>
        </h4>
        <div class="available-resources-list resource-section-content" data-resource-type="equipment">
          <p class="has-text-grey-light is-size-7">No available equipment</p>
        </div>
      </div>
    </div>
  </div>
  <% } %>
</div>

<%- await include('../_footerA'); -%>

<style>
  .shift-details li[draggable="true"] {
    cursor: move;
    padding: 0.25rem 0.5rem;
    margin: 0.25rem 0;
    border-radius: 4px;
    transition: background-color 0.2s;
  }
  
  .shift-details li[draggable="true"]:hover {
    background-color: rgba(0, 0, 0, 0.05);
  }
  
  .is-dragging {
    opacity: 0.5;
  }
  
  .is-drop-target {
    border: 2px dashed #3273dc;
    background-color: rgba(50, 115, 220, 0.05);
  }
  
  .shift-details ul {
    list-style: none;
    padding-left: 0;
  }

  /* Drop target styles */
  .drop-target-supervisor,
  .drop-target-crew,
  .drop-target-employee {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .drop-target-supervisor:hover,
  .drop-target-crew:hover,
  .drop-target-employee:hover {
    background-color: rgba(50, 115, 220, 0.05);
  }

  .drop-target-supervisor.is-drop-target,
  .drop-target-crew.is-drop-target,
  .drop-target-employee.is-drop-target {
    border: 2px solid #3273dc;
    background-color: rgba(50, 115, 220, 0.1);
  }

  #container--availableResources .available-items > div {
    cursor: move;
    transition: all 0.2s;
  }

  #container--availableResources .available-items > div:hover {
    background-color: rgba(0, 0, 0, 0.05);
    transform: translateX(2px);
  }

  #container--availableResources .available-items > div.is-dragging {
    opacity: 0.5;
  }

  #container--availableResources .box.is-drop-target {
    border: 2px solid #48c774;
    background-color: rgba(72, 199, 116, 0.05);
  }

  /* Make available resources sticky */
  #container--availableResources {
    position: sticky;
    top: 4.5rem;
    align-self: flex-start;
    max-height: calc(100vh - 5rem);
    overflow-y: auto;
  }

  /* Collapsible resource sections */
  .resource-section-header {
    cursor: pointer;
    user-select: none;
    transition: color 0.2s;
  }

  .resource-section-header:hover {
    color: #3273dc;
  }

  .resource-section-header .icon {
    transition: transform 0.2s;
  }

  .resource-section-header.is-collapsed .icon {
    transform: rotate(-90deg);
  }

  .resource-section-content {
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
    overflow: hidden;
    max-height: 5000px;
    opacity: 1;
  }

  .resource-section-content.is-hidden {
    max-height: 0;
    opacity: 0;
  }
</style>

<script>
  exports.shiftLog = Object.assign(exports.shiftLog || {}, {
    canManage: <%= user.userProperties.shifts.canManage %>,
    canUpdate: <%= user.userProperties.shifts.canUpdate %>,
    currentUser: '<%= user.userName %>'
  });
</script>
<script src="<%= urlPrefix %>/javascripts/shifts.builder.js"></script>

<%- await include('../_footerB'); -%>
